{
    "version": "https://jsonfeed.org/version/1",
    "title": "KAIIAK • All posts by \"smtp\" tag",
    "description": null,
    "home_page_url": "https://blog.iakmai.com",
    "items": [
        {
            "id": "https://blog.iakmai.com/2017/03/01/golang_smtp/",
            "url": "https://blog.iakmai.com/2017/03/01/golang_smtp/",
            "title": "Golang踩坑小结之SMTP",
            "date_published": "2017-02-28T16:16:30.000Z",
            "content_html": "<h1 id=\"smtp之golang标准库\"><a href=\"#smtp之golang标准库\" class=\"headerlink\" title=\"smtp之golang标准库\"></a>smtp之golang标准库</h1><p>函数<code>SendMail</code>就是标准库里面最简单的发送邮件的方法。</p>\n<figure class=\"highlight golang\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">SendMail</span><span class=\"params\">(addr <span class=\"keyword\">string</span>, a Auth, from <span class=\"keyword\">string</span>, to []<span class=\"keyword\">string</span>, msg []<span class=\"keyword\">byte</span>)</span> <span class=\"title\">error</span></span></span><br></pre></td></tr></table></figure>\n<p>对不熟悉smtp协议的小伙伴来说，最难的地方就是构造<code>msg</code>了。<br>在指定<code>smtp</code>的<a href=\"https://tools.ietf.org/html/rfc5321\" target=\"_blank\" rel=\"noopener\">RFC531</a>中，定义了<code>smtp</code>客户端和服务器的通讯方式和报文的格式。</p>\n<h2 id=\"缺陷\"><a href=\"#缺陷\" class=\"headerlink\" title=\"缺陷\"></a>缺陷</h2><p>现在的邮件服务器除了<code>25</code>端口外，还采用了其他的默认采用TLS的端口（只能TLS连接）。<br>但是标准库还会发送<code>STARTTLS</code>命令，但是服务器不会回应，这样就产生了阻塞。<br>以下是直接通过tls端口发送邮件的代码。</p>\n<figure class=\"highlight golang\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// SendMailTLS not use STARTTLS commond</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">SendMailTLS</span><span class=\"params\">(addr <span class=\"keyword\">string</span>, auth smtp.Auth, from <span class=\"keyword\">string</span>, to []<span class=\"keyword\">string</span>, msg []<span class=\"keyword\">byte</span>)</span> <span class=\"title\">error</span></span> &#123;</span><br><span class=\"line\">\thost, _, err := net.SplitHostPort(addr)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> err</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\ttlsconfig := &amp;tls.Config&#123;ServerName: host&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err = validateLine(from); err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> err</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> _, recp := <span class=\"keyword\">range</span> to &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> err = validateLine(recp); err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> err</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tconn, err := tls.Dial(<span class=\"string\">\"tcp\"</span>, addr, tlsconfig)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> err</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">defer</span> conn.Close()</span><br><span class=\"line\">\tc, err := smtp.NewClient(conn, host)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> err</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">defer</span> c.Close()</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err = c.Hello(<span class=\"string\">\"localhost\"</span>); err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> err</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err = c.Auth(auth); err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> err</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err = c.Mail(from); err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> err</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> _, addr := <span class=\"keyword\">range</span> to &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> err = c.Rcpt(addr); err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> err</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tw, err := c.Data()</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> err</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t_, err = w.Write(msg)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> err</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\terr = w.Close()</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> err</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> c.Quit()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// validateLine checks to see if a line has CR or LF as per RFC 5321</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">validateLine</span><span class=\"params\">(line <span class=\"keyword\">string</span>)</span> <span class=\"title\">error</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> strings.ContainsAny(line, <span class=\"string\">\"\\n\\r\"</span>) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> errors.New(<span class=\"string\">\"a line must not contain CR or LF\"</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">nil</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"MIME\"><a href=\"#MIME\" class=\"headerlink\" title=\"MIME\"></a>MIME</h1><blockquote>\n<p>多用途互联网邮件扩展（MIME，Multipurpose Internet Mail Extensions）是一个互联网标准，它扩展了电子邮件标准，使其能够支援：<br>非ASCII字符文本；<br>非文本格式附件（二进制、声音、图像等）；<br>由多部分（multiple parts）组成的消息体；<br>包含非ASCII字符的头信息（Header information）。这个标准被定义在RFC 2045、RFC 2046、RFC 2047、RFC 2048、RFC 2049等RFC中。<br>MIME改善了由RFC 822转变而来的RFC 2822，这些旧标准规定电子邮件标准并不允许在邮件消息中使用7位ASCII字符集以外的字符。正因如此，一些非英语字符消息和二进制文件，图像，声音等非文字消息原本都不能在电子邮件中传输（MIME可以）。MIME规定了用于表示各种各样的数据类型的符号化方法。此外，在万维网中使用的HTTP协议中也使用了MIME的框架，标准被扩展为互联网媒体类型。</p>\n</blockquote>\n<h2 id=\"基本格式\"><a href=\"#基本格式\" class=\"headerlink\" title=\"基本格式\"></a>基本格式</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">MIME-Version: 1.0</span><br><span class=\"line\">Content-Type: text&#x2F;plain</span><br><span class=\"line\">Content-transfer-encoding: base64</span><br><span class=\"line\">boundary &#x3D; XXXXXXXXXXXXXXXXX</span><br><span class=\"line\">--XXXXXXXXXXXXXXXXX</span><br><span class=\"line\">base64 string</span><br><span class=\"line\">--XXXXXXXXXXXXXXXXX</span><br><span class=\"line\">base64 string</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"邮件格式\"><a href=\"#邮件格式\" class=\"headerlink\" title=\"邮件格式\"></a>邮件格式</h1><h2 id=\"基本字段\"><a href=\"#基本字段\" class=\"headerlink\" title=\"基本字段\"></a>基本字段</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">From:来自测试发送&lt;aNxFi37X@outlook.com&gt;</span><br><span class=\"line\">To:aNxFi37X@outlook.com</span><br><span class=\"line\">Date:27 Mar 17 00:45 +0800</span><br><span class=\"line\">Cc:aNxFi37X@outlook.com</span><br><span class=\"line\">Subject: TEST</span><br></pre></td></tr></table></figure>\n<h2 id=\"bcc\"><a href=\"#bcc\" class=\"headerlink\" title=\"bcc\"></a>bcc</h2><p>密送的实现很好玩，在邮件内容里不填写信息，但是发送的时候发送给密送的那个人。<br>这里的设计很巧妙。</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a><CRLF></h2><p>以上的每一项都以<code>&lt;CRLF&gt;</code>结束，即<code>\\r\\n</code>。</p>\n<h2 id=\"邮件内容\"><a href=\"#邮件内容\" class=\"headerlink\" title=\"邮件内容\"></a>邮件内容</h2><p>这里使用MIME，当然也可以使用<code>8BITMIME</code>发送多媒体内容。<br>具体的方式是创建一个MIME part，每个part里面设置自己的<code>Content-Disposition</code>、<code>Content-Transfer-Encoding</code>、<code>Content-Type</code>。<br><code>Content-Transfer-Encoding</code>使用base64编码，不然直接发送<code>ascii</code>中含有<code>\\r\\n.\\r\\n</code>，邮件就直接结束了。<br>虽然编码率高了不少，但是简单，易操作，不依赖服务器支持<code>8BITMIME</code>。</p>\n<h2 id=\"邮件样例\"><a href=\"#邮件样例\" class=\"headerlink\" title=\"邮件样例\"></a>邮件样例</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">From:来自测试发送&lt;aNxFi37X@outlook.com&gt;</span><br><span class=\"line\">To:aNxFi37X@outlook.com</span><br><span class=\"line\">Date:27 Mar 17 00:45 +0800</span><br><span class=\"line\">Cc:aNxFi37X@outlook.com</span><br><span class=\"line\">Subject:&#x3D;?UTF-8?B?5rWL6K+V?&#x3D;</span><br><span class=\"line\">Content-Type: multipart&#x2F;mixed; boundary&#x3D;5b83f06665140150554c5847a8a3b05a5a9d64f5ec6a42fec16a4460223c</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">MIME-Version: 1.0</span><br><span class=\"line\">--5b83f06665140150554c5847a8a3b05a5a9d64f5ec6a42fec16a4460223c</span><br><span class=\"line\">Content-Transfer-Encoding: base64</span><br><span class=\"line\">Content-Type: text&#x2F;html</span><br><span class=\"line\"></span><br><span class=\"line\">PHA+6L+Z5piv5LiA5bCB5rWL6K+V6YKu5Lu2PC9wPg&#x3D;&#x3D;</span><br><span class=\"line\">--5b83f06665140150554c5847a8a3b05a5a9d64f5ec6a42fec16a4460223c</span><br><span class=\"line\">Content-Disposition: attachment; filename&#x3D;&quot;&#x3D;?UTF-8?B?MS50eHQ&#x3D;?&#x3D;&quot;</span><br><span class=\"line\">Content-Transfer-Encoding: base64</span><br><span class=\"line\">Content-Type: application&#x2F;application&#x2F;octet-stream</span><br><span class=\"line\"></span><br><span class=\"line\">MS50eHQ&#x3D;</span><br><span class=\"line\"></span><br><span class=\"line\">--5b83f06665140150554c5847a8a3b05a5a9d64f5ec6a42fec16a4460223c</span><br><span class=\"line\">Content-Disposition: attachment; filename&#x3D;&quot;&#x3D;?UTF-8?B?Mi50eHQ&#x3D;?&#x3D;&quot;</span><br><span class=\"line\">Content-Transfer-Encoding: base64</span><br><span class=\"line\">Content-Type: application&#x2F;application&#x2F;octet-stream</span><br><span class=\"line\"></span><br><span class=\"line\">Mi50eHQ&#x3D;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"发送过程\"><a href=\"#发送过程\" class=\"headerlink\" title=\"发送过程\"></a>发送过程</h1><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">S: 220 xyz.com Simple Mail Transfer Service Ready</span><br><span class=\"line\">C: EHLO foo.com</span><br><span class=\"line\">S: 250 xyz.com is on the air</span><br><span class=\"line\">C: MAIL FROM:&lt;@foo.com:JQP@bar.com&gt;</span><br><span class=\"line\">S: 250 OK</span><br><span class=\"line\">C: RCPT TO:&lt;Jones@XYZ.COM&gt;</span><br><span class=\"line\">S: 250 OK</span><br><span class=\"line\">C: DATA</span><br><span class=\"line\">S: 354 Start mail input; end with &lt;CRLF&gt;.&lt;CRLF&gt;</span><br><span class=\"line\">C: Received: from bar.com by foo.com ; Thu, 21 May 1998</span><br><span class=\"line\">C:     05:33:29 -0700</span><br><span class=\"line\">C: Date: Thu, 21 May 1998 05:33:22 -0700</span><br><span class=\"line\">C: From: John Q. Public &lt;JQP@bar.com&gt;</span><br><span class=\"line\">C: Subject:  The Next Meeting of the Board</span><br><span class=\"line\">C: To: Jones@xyz.com</span><br><span class=\"line\">C:</span><br><span class=\"line\">C: Bill:</span><br><span class=\"line\">C: The next meeting of the board of directors will be</span><br><span class=\"line\">C: on Tuesday.</span><br><span class=\"line\">C:                         John.</span><br><span class=\"line\">C: .</span><br><span class=\"line\">S: 250 OK</span><br><span class=\"line\">C: QUIT</span><br><span class=\"line\">S: 221 foo.com Service closing transmission channel</span><br></pre></td></tr></table></figure>\n<h2 id=\"HELO-or-EHLO\"><a href=\"#HELO-or-EHLO\" class=\"headerlink\" title=\"HELO or EHLO\"></a>HELO or EHLO</h2><p>确定服务器可用</p>\n<h2 id=\"MAIL\"><a href=\"#MAIL\" class=\"headerlink\" title=\"MAIL\"></a>MAIL</h2><p>声明发信邮箱</p>\n<h2 id=\"RCPT\"><a href=\"#RCPT\" class=\"headerlink\" title=\"RCPT\"></a>RCPT</h2><p>声明收件邮箱。密送的邮箱就是在这里声明，但是不写在邮件内容里面。</p>\n<h2 id=\"DATA\"><a href=\"#DATA\" class=\"headerlink\" title=\"DATA\"></a>DATA</h2><p>发送邮件的内容。</p>\n<h2 id=\"QUIT\"><a href=\"#QUIT\" class=\"headerlink\" title=\"QUIT\"></a>QUIT</h2><p>结束发送，并关闭连接。</p>\n<h1 id=\"拓展命令\"><a href=\"#拓展命令\" class=\"headerlink\" title=\"拓展命令\"></a>拓展命令</h1><h2 id=\"STARTLTLS\"><a href=\"#STARTLTLS\" class=\"headerlink\" title=\"STARTLTLS\"></a>STARTLTLS</h2><p>试探服务器是否支持TLS。</p>\n<h2 id=\"8BITMIME\"><a href=\"#8BITMIME\" class=\"headerlink\" title=\"8BITMIME\"></a>8BITMIME</h2><p>试探服务器是否支持8字长的编码。</p>\n<h2 id=\"其他\"><a href=\"#其他\" class=\"headerlink\" title=\"其他\"></a>其他</h2><p>其他的命令没有使用，这里挖个坑。</p>\n<center>\n一篇文章从一号拖到现在，真的好丢人啊。\n多谢您花费时间阅读我的文章，有不好的地方欢迎指正。\n</center>",
            "tags": [
                "GOLANG",
                "SMTP"
            ]
        }
    ]
}