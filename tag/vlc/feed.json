{
    "version": "https://jsonfeed.org/version/1",
    "title": "KAIIAK • All posts by \"vlc\" tag",
    "description": null,
    "home_page_url": "https://blog.iakmai.com",
    "items": [
        {
            "id": "https://blog.iakmai.com/2015/11/19/using-vlclib-in-vs/",
            "url": "https://blog.iakmai.com/2015/11/19/using-vlclib-in-vs/",
            "title": "C#利用VLC播放网络串流",
            "date_published": "2015-11-19T13:08:23.000Z",
            "content_html": "<p><a href=\"http://www.videolan.org\" target=\"_blank\" rel=\"noopener\">VLC的官方网站</a>，VLC的源代码是用C语言实现的。我们这里用<code>C#</code>的封装——nVLC。<br><a href=\"http://www.codeproject.com/Articles/109639/nVLC\" target=\"_blank\" rel=\"noopener\">nVLC</a>。</p>\n<h2 id=\"开始\"><a href=\"#开始\" class=\"headerlink\" title=\"开始\"></a>开始</h2><p>在运行本程序之前，请先安装VLC，或者拷贝<code>libvlc.dll</code>、<code>libvlccode.dll</code>和<code>plugins目录</code>到你的</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">using System;</span><br><span class=\"line\">using System.Windows.Forms;</span><br><span class=\"line\">using Declarations;</span><br><span class=\"line\">using Declarations.Enums;</span><br><span class=\"line\">using Declarations.Media;</span><br><span class=\"line\">using Declarations.Players;</span><br><span class=\"line\">using Implementation;</span><br><span class=\"line\"></span><br><span class=\"line\">namespace nVLC_Demo_MemoryInputOutput</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    public partial class Form1 : Form</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        IMediaPlayerFactory m_factory;</span><br><span class=\"line\">        IVideoPlayer m_sourcePlayer;</span><br><span class=\"line\">        IVideoPlayer m_renderPlayer;</span><br><span class=\"line\">        IMemoryInputMedia m_inputMedia;</span><br><span class=\"line\">        const long MicroSecondsInSecomd &#x3D; 1000 * 1000;</span><br><span class=\"line\">        long MicroSecondsBetweenFrame;</span><br><span class=\"line\">        long frameCounter;</span><br><span class=\"line\">        FrameData data &#x3D; new FrameData() &#123; DTS &#x3D; -1 &#125;;</span><br><span class=\"line\">        const int DefaultFps &#x3D; 24;</span><br><span class=\"line\">        Timer timer &#x3D; new Timer();</span><br><span class=\"line\"></span><br><span class=\"line\">        public Form1()</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            InitializeComponent();</span><br><span class=\"line\">            timer.Tick +&#x3D; new EventHandler(timer_Tick);</span><br><span class=\"line\">            timer.Interval &#x3D; 1000;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        void timer_Tick(object sender, EventArgs e)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            this.Text &#x3D; m_inputMedia.PendingFramesCount.ToString();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        protected override void OnLoad(EventArgs e)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            base.OnLoad(e);</span><br><span class=\"line\"></span><br><span class=\"line\">            m_factory &#x3D; new MediaPlayerFactory(true);</span><br><span class=\"line\">            m_sourcePlayer &#x3D; m_factory.CreatePlayer&lt;IVideoPlayer&gt;();</span><br><span class=\"line\">            m_sourcePlayer.Events.PlayerPlaying +&#x3D; new EventHandler(Events_PlayerPlaying);</span><br><span class=\"line\">            m_sourcePlayer.Mute &#x3D; true;</span><br><span class=\"line\">            m_renderPlayer &#x3D; m_factory.CreatePlayer&lt;IVideoPlayer&gt;();</span><br><span class=\"line\">            m_renderPlayer.WindowHandle &#x3D; panel1.Handle;</span><br><span class=\"line\">            m_inputMedia &#x3D; m_factory.CreateMedia&lt;IMemoryInputMedia&gt;(MediaStrings.IMEM);</span><br><span class=\"line\">            SetupOutput(m_sourcePlayer.CustomRendererEx);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        void Events_PlayerPlaying(object sender, EventArgs e)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            MicroSecondsBetweenFrame &#x3D; (long)(MicroSecondsInSecomd &#x2F; (m_sourcePlayer.FPS !&#x3D; 0 ? m_sourcePlayer.FPS : DefaultFps));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        private void SetupOutput(IMemoryRendererEx iMemoryRenderer)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            iMemoryRenderer.SetFormatSetupCallback(OnSetupCallback);</span><br><span class=\"line\">            iMemoryRenderer.SetExceptionHandler(OnErrorCallback);</span><br><span class=\"line\">            iMemoryRenderer.SetCallback(OnNewFrameCallback);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        private BitmapFormat OnSetupCallback(BitmapFormat format)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            SetupInput(format);</span><br><span class=\"line\">            return new BitmapFormat(format.Width, format.Height, ChromaType.RV24);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        private void OnErrorCallback(Exception error)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            MessageBox.Show(error.Message);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        private void OnNewFrameCallback(PlanarFrame frame)</span><br><span class=\"line\">        &#123;          </span><br><span class=\"line\">            data.Data &#x3D; frame.Planes[0];</span><br><span class=\"line\">            data.DataSize &#x3D; frame.Lenghts[0];</span><br><span class=\"line\">            data.PTS &#x3D; frameCounter++ * MicroSecondsBetweenFrame;</span><br><span class=\"line\">            m_inputMedia.AddFrame(data);</span><br><span class=\"line\"></span><br><span class=\"line\">            if (&#x2F;*m_inputMedia.PendingFramesCount &#x3D;&#x3D; 10 &amp;&amp; *&#x2F;!m_renderPlayer.IsPlaying)</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                m_renderPlayer.Play();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        private void SetupInput(BitmapFormat format)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            var streamInfo &#x3D; new StreamInfo();</span><br><span class=\"line\">            streamInfo.Category &#x3D; StreamCategory.Video;</span><br><span class=\"line\">            streamInfo.Codec &#x3D; VideoCodecs.BGR24;</span><br><span class=\"line\">            streamInfo.Width &#x3D; format.Width;</span><br><span class=\"line\">            streamInfo.Height &#x3D; format.Height;</span><br><span class=\"line\">            streamInfo.Size &#x3D; format.ImageSize;</span><br><span class=\"line\"></span><br><span class=\"line\">            m_inputMedia.Initialize(streamInfo);</span><br><span class=\"line\">            m_inputMedia.SetExceptionHandler(OnErrorCallback);</span><br><span class=\"line\">            m_renderPlayer.Open(m_inputMedia);           </span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        private void OpenSourceMedia(string path)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            &#x2F;&#x2F;IMediaFromFile media &#x3D; m_factory.CreateMedia&lt;IMediaFromFile&gt;(path);</span><br><span class=\"line\">            IMedia media &#x3D; m_factory.CreateMedia&lt;IMedia&gt;(path);</span><br><span class=\"line\">            m_sourcePlayer.Open(media);</span><br><span class=\"line\">            m_sourcePlayer.Play();</span><br><span class=\"line\">            timer.Start();</span><br><span class=\"line\">            </span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        private void button1_Click(object sender, EventArgs e)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            OpenSourceMedia(&quot;http:&#x2F;&#x2F;192.168.2.108:8090&quot;);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>",
            "tags": [
                "vlc",
                "CSharp"
            ]
        }
    ]
}